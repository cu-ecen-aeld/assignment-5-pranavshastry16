#!/bin/sh
#
# S98lddmodules
#
# SysV init script to automatically load and unload
# Linux Device Driver (LDD) modules at boot and shutdown.
#
# Modules handled:
#   - scull   (Simple Character Utility for Loading Localities)
#   - faulty  (Intentional fault driver for oops demonstration)
#   - hello   (Personalized hello printk module)
#
# This script is installed via rootfs overlay and executed
# automatically during system startup (S98 ordering).
#

case "$1" in
  start)
    echo "Loading LDD modules..."

    #
    # Load scull module
    # scull creates /dev/scull* character devices
    #
    if [ -f /lib/modules/$(uname -r)/extra/scull.ko ]; then
      # Load directly if installed in extra directory
      insmod /lib/modules/$(uname -r)/extra/scull.ko || true
    else
      # Otherwise attempt modprobe (uses module dependency tree)
      modprobe scull || true
    fi
          #
    # Create /dev/scull* device nodes (Buildroot often does not auto-create these)
    #
    SCULL_MAJOR=$(awk '$2=="scull" {print $1}' /proc/devices)
    if [ -n "$SCULL_MAJOR" ]; then
      mknod /dev/scull0 c $SCULL_MAJOR 0 2>/dev/null
      mknod /dev/scull1 c $SCULL_MAJOR 1 2>/dev/null
      mknod /dev/scull2 c $SCULL_MAJOR 2 2>/dev/null
      mknod /dev/scull3 c $SCULL_MAJOR 3 2>/dev/null
      chmod 666 /dev/scull* 2>/dev/null
    fi

    #
    # Load faulty module
    # faulty creates /dev/faulty and intentionally triggers a kernel oops
    # when written to (used for assignment debugging analysis)
    #
    if [ -f /lib/modules/$(uname -r)/extra/faulty.ko ]; then
      insmod /lib/modules/$(uname -r)/extra/faulty.ko || true
    else
      modprobe faulty || true
    fi
    #
    # Create /dev/faulty device node
    #
    FAULTY_MAJOR=$(awk '$2=="faulty" {print $1}' /proc/devices)
    if [ -n "$FAULTY_MAJOR" ]; then
      mknod /dev/faulty c $FAULTY_MAJOR 0 2>/dev/null
      chmod 666 /dev/faulty 2>/dev/null
    fi


    #
    # Load hello module
    # This prints a personalized message to the kernel log
    #
    modprobe hello || true
    ;;

  stop)
    echo "Unloading LDD modules..."

    #
    # Unload in reverse order of dependency
    # Suppress errors if module already removed
    #
    rmmod hello 2>/dev/null || true
    rmmod faulty 2>/dev/null || true
    rmmod scull  2>/dev/null || true
    ;;

  restart)
    #
    # Restart simply stops then starts the modules
    #
    $0 stop
    $0 start
    ;;

  *)
    #
    # Invalid usage handler
    #
    echo "Usage: $0 {start|stop|restart}"
    exit 1
    ;;
esac

exit 0
